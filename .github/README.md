# GitHub Workflow for NuGet Publishing

This directory contains the GitHub workflow for building, testing, and publishing the Brotal.FireflyIII NuGet package to nuget.org.

## About This Project

This C# SDK is automatically generated by the [OpenAPI Generator](https://openapi-generator.tech) project from the Firefly III API specification. The project provides a comprehensive .NET client library for interacting with the Firefly III personal finance manager API.

### Generation Details
- **SDK version**: 1.0.0
- **Generator version**: 7.16.0-SNAPSHOT
- **Build package**: org.openapitools.codegen.languages.CSharpClientCodegen
- **Target Framework**: .NET 9.0
- **API Version**: Firefly III API v6.3.0

### Regenerating the Library
To regenerate this library from the OpenAPI specification:

1. Create a `config.yaml` file:
```yaml
generatorName: csharp
inputSpec: https://api-docs.firefly-iii.org/firefly-iii-6.3.0-v1.yaml
outputDir: out

additionalProperties:
  packageGuid: '{0C876866-5C9F-4F05-BAA0-94B9382A2695}'
```

2. Run the OpenAPI Generator CLI:
```powershell
java -jar "<path>/openapi-generator/modules/openapi-generator-cli/target/openapi-generator-cli.jar" generate -c config.yaml
```

## Workflow Overview

The workflow (`build-and-publish.yml`) performs the following actions:

1. **Build Job**: Runs on every PR, tag push, and manual trigger
   - Extracts version from `src/Brotal.FireflyIII/Brotal.FireflyIII.csproj`
   - Restores dependencies
   - Builds the solution
   - Runs tests
   - Creates NuGet package using the csproj version
   - Uploads artifacts

2. **Publish Job**: Runs on version tags and manual triggers
   - Downloads the NuGet package
   - Validates the package
   - Checks if the version already exists on NuGet
   - Publishes to nuget.org (if version doesn't exist)
   - Creates a GitHub release (only for tag pushes)

## Setup Instructions

### 1. NuGet API Key Setup

To publish packages to nuget.org, you need to set up an API key:

#### Option A: Using NuGet.org Website
1. Go to [nuget.org](https://www.nuget.org)
2. Sign in to your account
3. Go to your profile → API Keys
4. Create a new API key
5. Copy the API key (you won't be able to see it again)

#### Option B: Using NuGet CLI
```bash
# Install NuGet CLI if you haven't already
dotnet tool install -g dotnet-nuget

# Login to NuGet
dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org
dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org -u YOUR_USERNAME -p YOUR_API_KEY --store-password-in-clear-text
```

### 2. GitHub Secrets Configuration

Add the following secrets to your GitHub repository:

1. Go to your repository → Settings → Secrets and variables → Actions
2. Click "New repository secret"
3. Add the following secret:
   - **Name**: `NUGET_API_KEY`
   - **Value**: Your NuGet API key from step 1

### 3. Repository Settings

Ensure your repository has the following settings:
- **Branch protection**: Enable for `main` or `master` branch
- **Required status checks**: Enable the workflow as a required check for PRs

## Usage

### Publishing a New Version

1. **Update Version**: Modify the `<Version>` in `src/Brotal.FireflyIII/Brotal.FireflyIII.csproj`
2. **Create Tag**: Create and push a version tag:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```
3. **Monitor**: Check the Actions tab in GitHub to monitor the build and publish process

### Manual Publishing

You can manually trigger the workflow to publish the current version:
1. Go to Actions tab in your repository
2. Select "Build and Publish NuGet Package"
3. Click "Run workflow"
4. Choose the branch and click "Run workflow"

**Note**: The workflow will check if the version already exists on NuGet and skip publishing if it does.

### Testing Locally

Before pushing, test the build locally:
```bash
# Restore dependencies
dotnet restore Brotal.FireflyIII.sln

# Build
dotnet build Brotal.FireflyIII.sln --configuration Release

# Test
dotnet test Brotal.FireflyIII.sln --configuration Release

# Pack
dotnet pack src/Brotal.FireflyIII/Brotal.FireflyIII.csproj --configuration Release --output nupkgs
```

## Version Management

The workflow uses the version specified in `src/Brotal.FireflyIII/Brotal.FireflyIII.csproj`:
- **Source**: `<Version>1.0.0</Version>` in the csproj file
- **No Override**: The workflow doesn't override this version
- **Duplicate Prevention**: Checks if the version already exists on NuGet before publishing

### Updating Version

To publish a new version:
1. Edit `src/Brotal.FireflyIII/Brotal.FireflyIII.csproj`
2. Change the `<Version>` tag to your new version (e.g., `1.0.1`)
3. Commit and push the changes
4. Create a corresponding Git tag: `git tag v1.0.1 && git push origin v1.0.1`

## Using the Library

### Basic Usage Example

```csharp
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Brotal.FireflyIII.Api;
using Brotal.FireflyIII.Client;
using Brotal.FireflyIII.Model;
using Org.OpenAPITools.Extensions;

namespace YourProject
{
    public class Program
    {
        public static async Task Main(string[] args)
        {
            var host = CreateHostBuilder(args).Build();
            var api = host.Services.GetRequiredService<IAboutApi>();
            IGetAboutApiResponse apiResponse = await api.GetAboutAsync("todo");
            SystemInfo? model = apiResponse.Ok();
        }

        public static IHostBuilder CreateHostBuilder(string[] args) => Host.CreateDefaultBuilder(args)
          .ConfigureApi((context, services, options) =>
          {
              // Configure Bearer token authentication
              BearerToken token = new("<your token>");
              options.AddTokens(token);

              // Configure HTTP client with retry policies
              options.AddApiHttpClients(client =>
              {
                  // client configuration
              }, builder =>
              {
                  builder
                      .AddRetryPolicy(2)
                      .AddTimeoutPolicy(TimeSpan.FromSeconds(5))
                      .AddCircuitBreakerPolicy(10, TimeSpan.FromSeconds(30));
              });
          });
    }
}
```

### Installation

```bash
dotnet add package Brotal.FireflyIII
```

## Troubleshooting

### Common Issues

1. **Authentication Failed**
   - Verify your `NUGET_API_KEY` secret is correctly set
   - Ensure the API key has publish permissions
   - Check if the API key is expired

2. **Package Already Exists**
   - The workflow automatically checks and skips if the version exists
   - Update the version in the csproj file before publishing
   - NuGet doesn't allow overwriting existing packages

3. **Build Failures**
   - Check the build logs in the Actions tab
   - Ensure all dependencies are properly restored
   - Verify the .NET version compatibility

4. **OpenAPI Generation Issues**
   - Ensure you have the correct OpenAPI Generator version
   - Verify the input specification URL is accessible
   - Check the configuration file format

5. **Version Not Published**
   - Check if the version already exists on NuGet
   - Verify the version in csproj file is correct
   - Ensure the workflow completed successfully

### Useful Commands

```bash
# Check package contents
dotnet nuget list source

# Verify package
dotnet nuget verify nupkgs/*.nupkg

# Test package locally
dotnet nuget add source ./nupkgs -n local
dotnet add package Brotal.FireflyIII --source local

# Regenerate from OpenAPI spec
java -jar openapi-generator-cli.jar generate -c config.yaml

# Check if package version exists on NuGet
curl -s "https://api.nuget.org/v3/registration3/Brotal.FireflyIII/index.json" | grep -o '"version":"[^"]*"'
```

## Security Notes

- Never commit API keys to your repository
- Use GitHub secrets for sensitive information
- Regularly rotate your NuGet API keys
- Consider using scoped API keys for better security
- Keep the OpenAPI Generator CLI updated for security patches

## Support

If you encounter issues:
1. Check the workflow logs in the Actions tab
2. Verify your NuGet API key is valid
3. Ensure your package version is unique
4. Check NuGet.org status page for service issues
5. Review the [OpenAPI Generator documentation](https://openapi-generator.tech/docs/generators/csharp)
6. Check the [Firefly III API documentation](https://docs.firefly-iii.org/references/firefly-iii/api/)

## Related Links

- [NuGet Package](https://www.nuget.org/packages/Brotal.FireflyIII/)
- [Firefly III API Documentation](https://docs.firefly-iii.org/references/firefly-iii/api/)
- [OpenAPI Generator](https://openapi-generator.tech)
- [GitHub Repository](https://github.com/skb50bd/firefly-iii-ai-ingest)
